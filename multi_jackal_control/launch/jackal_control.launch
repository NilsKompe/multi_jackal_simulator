<?xml version="1.0"?>

<!-- This file launches the Jackal robot controller spawner, which plugs into
     gazebo to allow the Jackal to be controlled. -->
     
<launch>
  <!-- Namespace must be unique. -->
  <arg name="ns" default="jackal0"/>
  <arg name="joystick" default="true"/>
  <arg name="joy_dev" default="$(optenv JACKAL_JOY_DEVICE /dev/input/js0)" />

  <!-- Load the controller parameters. Also add the namespace to the frames, this 
       can't be done in the YAML file so we override it here. -->
  <rosparam command="load" 
            file="$(find multi_jackal_control)/config/jackal_control_config.yaml" 
            ns="$(arg ns)"
  />
  <param name="$(arg ns)/jackal_velocity_controller/odom_frame_id" value="$(arg ns)/odom"/>
  <param name="$(arg ns)/jackal_velocity_controller/base_frame_id" value="$(arg ns)/base_link"/>
  
  <!-- Spawn the jackal controls. -->
  <node name="controller_spawner" pkg="controller_manager" type="spawner"
      args="jackal_joint_publisher jackal_velocity_controller" ns="$(arg ns)">
  </node>

  <!-- Added for joystick control -->
  <group if="$(arg joystick)">

    <group unless="$(optenv JACKAL_PS3 0)" >
      <rosparam command="load" file="$(find jackal_control)/config/teleop_ps4.yaml" />
      <param name="joy_node/dev" value="$(arg joy_dev)" />
    </group>

    <group if="$(optenv JACKAL_PS3 0)" >
      <rosparam command="load" file="$(find jackal_control)/config/teleop_ps3.yaml" />
      <param name="joy_node/dev" value="$(arg joy_dev)" />
    </group>

    <node pkg="joy" type="joy_node" name="joy_node" />

    <node pkg="teleop_twist_joy" type="teleop_node" name="teleop_twist_joy">
      <remap from="cmd_vel" to="jackal0/jackal_velocity_controller/cmd_vel" />
    </node>
  </group>
        
  <!-- Create a control marker for manual control using RVIZ. -->
  <node pkg="interactive_marker_twist_server" type="marker_server" name="twist_marker_server" ns="$(arg ns)">
    <remap from="twist_marker_server/cmd_vel" to="jackal_velocity_controller/cmd_vel" />
    <param name="link_name" value="$(arg ns)/base_link"/>
  </node> 

</launch>
